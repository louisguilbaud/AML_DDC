<!DOCTYPE html>
<html lang="en">
<head>
    <script src='./javascripts/sas/util/messagingUtil.js'></script>
    <script src="./javascripts/jquery/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Debugging</title>
</head>
<body>
    <h1>API Key Debugging</h1>
    <div id="apiKeyContainer">Fetching API Key...</div>
    <div id="apiResponseQ&A">Fetching OpenAI Response...</div>

    <script>
        "use strict";
        va.messagingUtil.setOnDataReceivedCallback(updateURL);

        function updateURL(vaMsgObj) {
            console.log('Received vaMsgObj:', vaMsgObj);
            if (vaMsgObj && vaMsgObj.data && vaMsgObj.data.length > 0) {
                const apiKey = vaMsgObj.data[0][0];
                console.log('Fetched API Key:', apiKey);
                document.getElementById("apiKeyContainer").textContent = 'API Key: ' + apiKey;
                fetchOpenAIResponse(apiKey);
            } else {
                document.getElementById("apiKeyContainer").textContent = "No API key available";
            }
        }

        function fetchOpenAIResponse(apiKey) {
            console.log('Using API Key:', apiKey);
            fetch('https://api.openai.com/v1/chat/completions', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + apiKey
                },
                body: JSON.stringify({
                    "model": "gpt-3.5-turbo",
                    "messages": [{"role": "user", "content": "Test message"}]
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('OpenAI API response was not ok ' + response.statusText);
                return response.json();
            })
            .then(data => {
                var answer = data.choices[0].message.content;
                console.log('OpenAI API Response:', data);
                document.getElementById("apiResponseQ&A").textContent = answer;
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("apiResponseQ&A").textContent = "Error occurred while fetching API data.";
            });
        }
    </script>
</body>
</html>
